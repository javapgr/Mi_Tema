<!-- Newsletter Brevo - Listo para Usar -->
<!-- Incluye este snippet en tus colecciones -->

<section class="newsletter-brevo">
  <div class="container">
    <div class="newsletter-brevo__content">
      <h2 class="newsletter-brevo__title">{{ section.settings.title }}</h2>
      <p class="newsletter-brevo__subtitle">{{ section.settings.subtitle }}</p>
      
      <form class="newsletter-brevo__form" id="brevo-form">
        <input
          type="email"
          name="email"
          placeholder="{{ section.settings.placeholder }}"
          required
          class="newsletter-brevo__input"
          autocomplete="email"
        >
        <button type="submit" class="newsletter-brevo__button">
          {{ section.settings.button_text }}
        </button>
      </form>

      <div id="brevo-message" class="newsletter-brevo__message"></div>
      
      {% if section.settings.show_privacy %}
        <p class="newsletter-brevo__privacy">
          {{ section.settings.privacy_text }}
        </p>
      {% endif %}
    </div>
  </div>
</section>

<script>
(function() {
  'use strict';

  // REEMPLAZA ESTOS VALORES CON LOS TUYOS DE BREVO
  const BREVO_API_KEY = '{{ section.settings.brevo_api_key }}';
  const BREVO_LIST_ID = {{ section.settings.list_id }};
  const CATEGORY = '{{ section.settings.category }}';
  const API_ENDPOINT = 'https://api.brevo.com/v3/contacts';

  const form = document.getElementById('brevo-form');
  const messageEl = document.getElementById('brevo-message');

  // Limpiar mensaje anterior
  function clearMessage() {
    messageEl.textContent = '';
    messageEl.className = 'newsletter-brevo__message';
  }

  // Mostrar mensaje
  function showMessage(text, type = 'success') {
    messageEl.textContent = text;
    messageEl.className = `newsletter-brevo__message newsletter-brevo__message--${type}`;

    if (type === 'success') {
      setTimeout(clearMessage, 5000);
    }
  }

  // Validar email
  function validateEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
  }

  // Enviar a Brevo
  async function subscribeToBrevo(email) {
    if (!validateEmail(email)) {
      showMessage('❌ Por favor ingresa un email válido', 'error');
      return false;
    }

    if (!BREVO_API_KEY) {
      showMessage('❌ Newsletter no configurada', 'error');
      return false;
    }

    try {
      showMessage('⏳ Suscribiendo...', 'loading');

      const response = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: {
          'accept': 'application/json',
          'api-key': BREVO_API_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          email: email,
          attributes: {
            FIRSTNAME: 'Cliente',
            CATEGORY: CATEGORY,
            SIGNUP_SOURCE: 'website',
            SIGNUP_DATE: new Date().toISOString(),
            STORE: 'ISSLAM'
          },
          listIds: [parseInt(BREVO_LIST_ID)],
          updateEnabled: true // Si el contacto existe, actualiza
        })
      });

      if (response.status === 201 || response.status === 204) {
        showMessage('✅ ¡Bienvenido! Revisa tu email de confirmación', 'success');
        form.reset();
        
        // Track en Google Analytics si existe
        if (window.gtag) {
          gtag('event', 'newsletter_signup', {
            'category': CATEGORY,
            'email': email
          });
        }

        return true;
      } else if (response.status === 400) {
        const error = await response.json();
        if (error.code === 'INVALID_EMAIL') {
          showMessage('❌ Email inválido', 'error');
        } else {
          showMessage('❌ Email ya suscrito', 'info');
        }
        return false;
      } else {
        showMessage('❌ Error al suscribirse. Intenta más tarde', 'error');
        return false;
      }
    } catch (error) {
      console.error('Error en suscripción:', error);
      showMessage('❌ Error de conexión. Intenta más tarde', 'error');
      return false;
    }
  }

  // Event listener
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = this.querySelector('input[name="email"]').value;
    await subscribeToBrevo(email);
  });

  // Autofocus
  form.querySelector('input[name="email"]').focus();
})();
</script>

<style>
  .newsletter-brevo {
    padding: 3rem 0;
    background: rgba(0, 0, 0, 0.1);
    margin: 2rem 0;
  }

  .newsletter-brevo__content {
    text-align: center;
    max-width: 600px;
    margin: 0 auto;
  }

  .newsletter-brevo__title {
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
    color: inherit;
  }

  .newsletter-brevo__subtitle {
    font-size: 1rem;
    margin-bottom: 2rem;
    opacity: 0.8;
    color: inherit;
  }

  .newsletter-brevo__form {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .newsletter-brevo__input {
    flex: 1;
    min-width: 250px;
    padding: 0.75rem 1rem;
    border: 2px solid currentColor;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: inherit;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .newsletter-brevo__input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
  }

  .newsletter-brevo__input::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }

  .newsletter-brevo__button {
    padding: 0.75rem 2rem;
    background: currentColor;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .newsletter-brevo__button:hover {
    opacity: 0.8;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .newsletter-brevo__button:active {
    transform: translateY(0);
  }

  .newsletter-brevo__message {
    min-height: 1.5rem;
    font-weight: bold;
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }

  .newsletter-brevo__message--success {
    color: #10B981;
  }

  .newsletter-brevo__message--error {
    color: #FF6B6B;
  }

  .newsletter-brevo__message--info {
    color: #3B82F6;
  }

  .newsletter-brevo__message--loading {
    color: #F59E0B;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from {
      opacity: 0.6;
    }
    to {
      opacity: 1;
    }
  }

  .newsletter-brevo__privacy {
    font-size: 0.8rem;
    opacity: 0.6;
    margin-top: 1rem;
    line-height: 1.4;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .newsletter-brevo {
      padding: 2rem 1rem;
    }

    .newsletter-brevo__title {
      font-size: 1.4rem;
    }

    .newsletter-brevo__form {
      flex-direction: column;
      gap: 0.75rem;
    }

    .newsletter-brevo__input,
    .newsletter-brevo__button {
      width: 100%;
    }
  }
</style>

{% schema %}
{
  "name": "Newsletter - Brevo",
  "settings": [
    {
      "type": "header",
      "content": "Contenido Newsletter"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Título",
      "default": "Suscríbete a Nuestro Newsletter"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtítulo",
      "default": "Recibe las últimas novedades directamente en tu correo"
    },
    {
      "type": "text",
      "id": "placeholder",
      "label": "Placeholder del input",
      "default": "tu@email.com"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Texto del botón",
      "default": "Suscribirse"
    },
    {
      "type": "header",
      "content": "Configuración Brevo"
    },
    {
      "type": "text",
      "id": "brevo_api_key",
      "label": "API Key de Brevo",
      "info": "Obtén tu API Key en: Brevo → Settings → API & Webhooks → v3 Keys",
      "placeholder": "xkeysib_..."
    },
    {
      "type": "number",
      "id": "list_id",
      "label": "ID de Lista en Brevo",
      "info": "Obtén el ID en: Brevo → Contacts → Lists → (tu lista)"
    },
    {
      "type": "text",
      "id": "category",
      "label": "Categoría (para tracking)",
      "default": "general"
    },
    {
      "type": "header",
      "content": "Privacy"
    },
    {
      "type": "checkbox",
      "id": "show_privacy",
      "label": "Mostrar texto de privacidad",
      "default": true
    },
    {
      "type": "text",
      "id": "privacy_text",
      "label": "Texto de privacidad",
      "default": "Respetamos tu privacidad. Desuscribete en cualquier momento."
    }
  ],
  "presets": [
    {
      "name": "Newsletter Brevo",
      "settings": {
        "title": "Suscríbete al Newsletter",
        "category": "general"
      }
    }
  ]
}
{% endschema %}

<!-- SecciÃ³n Principal de Producto -->
<section class="product section" data-product-section data-product-section-id="{{ section.id }}">
  <div class="container">
    <div class="product__wrapper">
      <!-- GalerÃ­a de imÃ¡genes -->
      <div class="product__gallery">
        <div class="product__main-image">
          {% if product.featured_image %}
            <img 
              src="{{ product.featured_image | image_url: width: 800 }}"
              alt="{{ product.featured_image.alt | escape }}"
              class="product__image"
              loading="eager"
            >
          {% else %}
            {{ 'product-1' | placeholder_svg_tag: 'product__image placeholder' }}
          {% endif %}
        </div>
        
        {% if product.images.size > 1 %}
          <div class="product__thumbnails">
            {% for image in product.images %}
              <button type="button" class="product__thumbnail {% if forloop.first %}is-active{% endif %}" data-image-id="{{ image.id }}" data-image-url="{{ image | image_url: width: 1200 }}" data-image-alt="{{ image.alt | escape }}">
                <img 
                  src="{{ image | image_url: width: 150 }}"
                  alt="{{ image.alt | escape }}"
                  loading="lazy"
                >
              </button>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- InformaciÃ³n del producto -->
      <div class="product__info">
        <h1 class="product__title">{{ product.title }}</h1>
        
        <div class="product__price">
          {% if product.compare_at_price > product.price %}
            <span class="product__price-compare">{{ product.compare_at_price | money }}</span>
          {% endif %}
          <span class="product__price-current" data-unit-price="{{ product.selected_or_first_available_variant.price }}">{{ product.price | money }}</span>
          {% if product.compare_at_price > product.price %}
            <span class="product__price-badge">OFERTA</span>
          {% endif %}
        </div>

        {% form 'product', product, class: 'product__form' %}
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
          
          {% unless product.has_only_default_variant %}
            {% for option in product.options_with_values %}
              {% assign option_index = forloop.index0 %}
              <div class="product__option">
                <label class="product__option-label">{{ option.name }}</label>
                <div class="product__option-values">
                  {% for value in option.values %}
                    <button type="button" class="product__option-value {% if option.selected_value == value %}is-selected{% endif %}" data-option-index="{{ option_index }}" data-option-value="{{ value | escape }}">
                      {{ value }}
                    </button>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          {% endunless %}

          <div class="product__form-inline">
            <div class="product__quantity">
              <label class="product__option-label">Cantidad</label>
              <div class="product__quantity-selector">
                <button type="button" class="product__quantity-btn" data-action="decrease">âˆ’</button>
                <input type="number" name="quantity" value="1" min="1" class="product__quantity-input">
                <button type="button" class="product__quantity-btn" data-action="increase">+</button>
              </div>
            </div>

            <div class="product__option product__delivery-option">
              <label class="product__option-label">EnvÃ­o</label>
              <div class="product__option-values">
                <button type="button" class="product__option-value is-selected" data-delivery="normal" data-delivery-extra="0">Normal</button>
                <button type="button" class="product__option-value" data-delivery="express" data-delivery-extra="1000">Express</button>
              </div>
              <input type="hidden" name="properties[EnvÃ­o]" value="Normal">
            </div>

            <button type="button" class="btn btn--primary product__whatsapp-order" id="productWhatsappBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.67-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.076 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421-7.403h-.004a9.87 9.87 0 00-9.746 9.798c0 2.734.732 5.41 2.124 7.738L2.883 22l8.26-2.673A9.87 9.87 0 0012.168 2c5.433 0 9.857 4.424 9.857 9.857 0 5.433-4.424 9.857-9.857 9.857z"/>
              </svg>
              Pedir por WhatsApp
            </button>
          </div>
        {% endform %}

        {% if product.description != blank %}
          <div class="product__description">
            <h3>DescripciÃ³n</h3>
            {{ product.description }}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<style>
  .product__wrapper {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6rem;
    align-items: start;
  }

  .product__gallery {
    position: sticky;
    top: 120px;
  }

  .product__main-image {
    border-radius: var(--border-radius);
    overflow: hidden;
    background-color: #f5f5f5;
    margin-bottom: 1.5rem;
  }

  .product__image {
    width: 100%;
    height: auto;
  }

  .product__thumbnails {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .product__thumbnail {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid transparent;
    cursor: pointer;
    padding: 0;
    background: none;
    transition: border-color 0.3s ease;
  }

  .product__thumbnail.is-active,
  .product__thumbnail:hover {
    border-color: var(--color-primary);
  }

  .product__thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product__title {
    font-size: 3.2rem;
    margin-bottom: 1.5rem;
  }

  .product__price {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 3rem;
  }

  .product__price-current {
    font-size: 2.8rem;
    font-weight: 700;
    color: var(--color-primary);
  }

  .product__price-compare {
    font-size: 2rem;
    color: var(--color-text-light);
    text-decoration: line-through;
  }

  .product__price-badge {
    background-color: #ef4444;
    color: white;
    padding: 0.4rem 1rem;
    border-radius: 4px;
    font-size: 1.2rem;
    font-weight: 700;
    text-transform: uppercase;
  }

  .product__option {
    margin-bottom: 2rem;
  }

  .product__form-inline .product__option {
    margin-bottom: 0;
  }

  .product__option-label {
    display: block;
    font-weight: 600;
    margin-bottom: 1rem;
    font-size: 1.4rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .product__option-values {
    display: flex;
    flex-wrap: wrap;
    gap: 0.8rem;
  }

  .product__option-value {
    padding: 1rem 2rem;
    border: 2px solid #e5e5e5;
    border-radius: 8px;
    background: none;
    cursor: pointer;
    font-size: 1.4rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .product__option-value:hover,
  .product__option-value.is-selected {
    border-color: var(--color-primary);
    background-color: var(--color-primary);
    color: white;
  }

  .product__form-inline {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-end;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .product__quantity {
    margin-bottom: 0;
  }

  .product__quantity-selector {
    display: inline-flex;
    border: 2px solid #e5e5e5;
    border-radius: 8px;
    overflow: hidden;
  }

  .product__quantity-btn {
    width: 44px;
    height: 44px;
    border: none;
    background: none;
    font-size: 2rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .product__quantity-btn:hover {
    background-color: #f5f5f5;
  }

  .product__quantity-input {
    width: 60px;
    text-align: center;
    border: none;
    font-size: 1.6rem;
    font-weight: 600;
    -moz-appearance: textfield;
  }

  .product__quantity-input::-webkit-outer-spin-button,
  .product__quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .product__add-to-cart {
    width: 100%;
    padding: 1.8rem;
    font-size: 1.6rem;
    margin-bottom: 3rem;
  }

  .product__add-to-cart:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
  }

  .product__whatsapp-order {
    flex: 1;
    min-width: 200px;
    padding: 1.4rem 2rem;
    font-size: 1.5rem;
    margin-bottom: 0;
    background: #25d366;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.8rem;
  }

  .product__whatsapp-order:hover {
    background: #1fb855;
  }

  .product__description {
    padding-top: 3rem;
    border-top: 1px solid #e5e5e5;
  }

  .product__description h3 {
    font-size: 1.8rem;
    margin-bottom: 1.5rem;
  }

  @media (max-width: 1024px) {
    .product__wrapper {
      grid-template-columns: 1fr;
      gap: 3rem;
    }

    .product__gallery {
      position: static;
    }
  }

  @media (max-width: 640px) {
    .product__form-inline {
      flex-direction: column;
      align-items: stretch;
    }

    .product__whatsapp-order {
      min-width: 100%;
    }
  }
</style>

<script>
  (function() {
    const section = document.querySelector('[data-product-section-id="{{ section.id }}"]');
    if (!section) return;

    const form = section.querySelector('form');
    if (!form) return;

    const variantInput = form.querySelector('input[name="id"]');
    if (!variantInput) return;

    const variants = {{ product.variants | json | replace: '<\/script>', '<\\/script>' }};
    const optionsCount = {{ product.options.size }};
    const optionButtons = section.querySelectorAll('.product__option-value:not([data-delivery])');
    const quantityInput = section.querySelector('.product__quantity-input');
    const quantityButtons = section.querySelectorAll('.product__quantity-btn[data-action]');
    const thumbnails = section.querySelectorAll('.product__thumbnail');
    const mainImage = section.querySelector('.product__main-image img');

    const whatsappBtn = section.querySelector('#productWhatsappBtn');
    const deliveryButtons = section.querySelectorAll('[data-delivery]');
    const deliveryInput = form.querySelector('input[name="properties[EnvÃ­o]"]');

    const whatsappNumber = '{{ section.settings.whatsapp_number | default: settings.social_whatsapp | default: "51987654321" }}';

    let currentVariant = variants.find(variant => variant.id === Number(variantInput.value)) || variants[0];
    const selectedOptions = Array.from({ length: optionsCount }, (_, index) => currentVariant ? currentVariant[`option${index + 1}`] : null);
    let deliveryExtra = 'Normal';

    const findMatchingVariant = () => {
      return variants.find(variant => selectedOptions.every((value, index) => {
        if (value === null || value === undefined) {
          return true;
        }
        return variant[`option${index + 1}`] === value;
      }));
    };

    if (currentVariant) {
      variantInput.value = currentVariant.id;
    }

    optionButtons.forEach(button => {
      button.addEventListener('click', () => {
        const optionIndex = Number(button.dataset.optionIndex);
        const optionValue = button.dataset.optionValue;
        if (Number.isNaN(optionIndex) || !optionValue) return;

        selectedOptions[optionIndex] = optionValue;

        optionButtons.forEach(other => {
          if (Number(other.dataset.optionIndex) === optionIndex) {
            other.classList.remove('is-selected');
          }
        });
        button.classList.add('is-selected');

        const matchedVariant = findMatchingVariant();
        if (matchedVariant) {
          currentVariant = matchedVariant;
          variantInput.value = matchedVariant.id;
        }
      });
    });

    quantityButtons.forEach(button => {
      button.addEventListener('click', () => {
        if (!quantityInput) return;
        let current = Number(quantityInput.value);
        if (Number.isNaN(current) || current < 1) {
          current = 1;
        }

        if (button.dataset.action === 'increase') {
          quantityInput.value = current + 1;
        } else if (button.dataset.action === 'decrease') {
          quantityInput.value = Math.max(1, current - 1);
        }
      });
    });

    deliveryButtons.forEach(button => {
      button.addEventListener('click', () => {
        deliveryButtons.forEach(other => other.classList.remove('is-selected'));
        button.classList.add('is-selected');
        deliveryExtra = button.dataset.delivery === 'express' ? 'Express' : 'Normal';
        if (deliveryInput) {
          deliveryInput.value = deliveryExtra + (button.dataset.delivery === 'express' ? ' (+S/. 10.00)' : '');
        }
      });
    });

    thumbnails.forEach(thumbnail => {
      thumbnail.addEventListener('click', () => {
        const imageUrl = thumbnail.dataset.imageUrl;
        const imageAlt = thumbnail.dataset.imageAlt || '';
        if (imageUrl && mainImage) {
          mainImage.src = imageUrl;
          if (imageAlt) {
            mainImage.alt = imageAlt;
          }
        }

        thumbnails.forEach(entry => entry.classList.remove('is-active'));
        thumbnail.classList.add('is-active');
      });
    });

    // WhatsApp Order
    if (whatsappBtn) {
      whatsappBtn.addEventListener('click', () => {
        const titulo = '{{ product.title | escape }}';
        const opciones = selectedOptions.filter(o => o).join(', ');
        const cantidad = quantityInput ? quantityInput.value : '1';
        const envio = deliveryExtra;
        const precio = '{{ product.selected_or_first_available_variant.price | money }}';

        const mensaje = `Hola ISSLAM, me gustarÃ­a realizar un pedido:%0A%0AðŸ“¦ Producto: ${titulo}%0AðŸŽ¨ Opciones: ${opciones}%0AðŸ“Š Cantidad: ${cantidad}%0AðŸšš EnvÃ­o: ${envio}%0AðŸ’° Precio: ${precio}%0A%0AÂ¿CÃ³mo puedo realizar el pago?`;

        const urlWhatsapp = `https://wa.me/${whatsappNumber}?text=${mensaje}`;
        window.open(urlWhatsapp, '_blank');
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Producto Principal",
  "tag": "section",
  "class": "product-section",
  "settings": [
    {
      "type": "text",
      "id": "whatsapp_number",
      "label": "NÃºmero de WhatsApp para pedidos",
      "info": "NÃºmero con cÃ³digo de paÃ­s, sin +. Ej: 51987654321. Si estÃ¡ vacÃ­o, usa el de Redes Sociales del tema."
    }
  ]
}
{% endschema %}

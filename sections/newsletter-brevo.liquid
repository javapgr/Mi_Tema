<!-- Sección: Newsletter Brevo -->
<section class="newsletter-brevo section">
  <div class="newsletter-brevo__content">
    <h2 class="newsletter-brevo__title">{{ section.settings.title }}</h2>
    <p class="newsletter-brevo__subtitle">{{ section.settings.subtitle }}</p>

    <form class="newsletter-brevo__form" id="brevo-form-{{ section.id }}">
      <input
        type="email"
        name="email"
        placeholder="{{ section.settings.placeholder }}"
        required
        class="newsletter-brevo__input"
        autocomplete="email"
      >
      <button type="submit" class="newsletter-brevo__button">
        {{ section.settings.button_text }}
      </button>
    </form>

    <div id="brevo-message-{{ section.id }}" class="newsletter-brevo__message"></div>

    {% if section.settings.show_privacy %}
      <p class="newsletter-brevo__privacy">
        {{ section.settings.privacy_text }}
      </p>
    {% endif %}
  </div>
</section>

<script>
(function() {
  'use strict';

  const sectionId = '{{ section.id }}';
  const BREVO_API_KEY = '{{ section.settings.brevo_api_key }}';
  const BREVO_LIST_ID = {{ section.settings.list_id }};
  const CATEGORY = '{{ section.settings.category | escape }}';
  const API_ENDPOINT = 'https://api.brevo.com/v3/contacts';

  const form = document.getElementById(`brevo-form-${sectionId}`);
  const messageEl = document.getElementById(`brevo-message-${sectionId}`);

  if (!form || !messageEl) return;

  function clearMessage() {
    messageEl.textContent = '';
    messageEl.className = 'newsletter-brevo__message';
  }

  function showMessage(text, type = 'success') {
    messageEl.textContent = text;
    messageEl.className = `newsletter-brevo__message newsletter-brevo__message--${type}`;

    if (type === 'success') {
      setTimeout(clearMessage, 5000);
    }
  }

  function validateEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
  }

  async function subscribeToBrevo(email) {
    if (!validateEmail(email)) {
      showMessage('❌ Por favor ingresa un email válido', 'error');
      return false;
    }

    if (!BREVO_API_KEY) {
      showMessage('❌ Newsletter no configurada', 'error');
      return false;
    }

    try {
      showMessage('⏳ Suscribiendo...', 'loading');

      const response = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: {
          'accept': 'application/json',
          'api-key': BREVO_API_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          email: email,
          attributes: {
            FIRSTNAME: 'Cliente',
            CATEGORY: CATEGORY,
            SIGNUP_SOURCE: 'website',
            SIGNUP_DATE: new Date().toISOString(),
            STORE: 'ISSLAM'
          },
          listIds: [parseInt(BREVO_LIST_ID)],
          updateEnabled: true
        })
      });

      if (response.status === 201 || response.status === 204) {
        showMessage('✅ ¡Bienvenido! Revisa tu email de confirmación', 'success');
        form.reset();

        if (window.gtag) {
          gtag('event', 'newsletter_signup', {
            category: CATEGORY,
            email: email
          });
        }

        return true;
      } else if (response.status === 400) {
        const error = await response.json();
        if (error.code === 'INVALID_EMAIL') {
          showMessage('❌ Email inválido', 'error');
        } else {
          showMessage('❌ Email ya suscrito', 'info');
        }
        return false;
      } else {
        showMessage('❌ Error al suscribirse. Intenta más tarde', 'error');
        return false;
      }
    } catch (error) {
      console.error('Error en suscripción:', error);
      showMessage('❌ Error de conexión. Intenta más tarde', 'error');
      return false;
    }
  }

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = this.querySelector('input[name="email"]').value;
    await subscribeToBrevo(email);
  });

  form.querySelector('input[name="email"]').focus();
})();
</script>

<style>
  .newsletter-brevo {
    padding: 3rem 0;
    background: linear-gradient(135deg, #FF0000 0%, #1a1a1a 100%);
    color: #fff;
    text-align: center;
  }

  .newsletter-brevo__content {
    max-width: 600px;
    margin: 0 auto;
  }

  .newsletter-brevo__title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .newsletter-brevo__subtitle {
    font-size: 1rem;
    margin-bottom: 1.5rem;
    opacity: 0.85;
  }

  .newsletter-brevo__form {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 1.5rem;
  }

  .newsletter-brevo__input {
    flex: 1;
    min-width: 250px;
    padding: 0.75rem 1rem;
    border: 2px solid rgba(255, 255, 255, 0.5);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
    color: #fff;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .newsletter-brevo__input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 12px rgba(255, 255, 255, 0.4);
  }

  .newsletter-brevo__input::placeholder {
    color: rgba(255, 255, 255, 0.6);
  }

  .newsletter-brevo__button {
    padding: 0.75rem 2rem;
    border-radius: 8px;
    background: #fff;
    color: #1a1a1a;
    font-weight: 700;
    border: none;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .newsletter-brevo__button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
  }

  .newsletter-brevo__message {
    min-height: 1.2rem;
    font-weight: 600;
  }

  .newsletter-brevo__message--success {
    color: #10B981;
  }

  .newsletter-brevo__message--error {
    color: #FF6B6B;
  }

  .newsletter-brevo__message--info {
    color: #38BDF8;
  }

  .newsletter-brevo__message--loading {
    color: #F59E0B;
  }

  .newsletter-brevo__privacy {
    font-size: 0.85rem;
    opacity: 0.7;
    max-width: 420px;
    margin: 0 auto;
  }

  @media (max-width: 768px) {
    .newsletter-brevo {
      padding: 2rem 1rem;
    }

    .newsletter-brevo__form {
      flex-direction: column;
      gap: 0.75rem;
    }

    .newsletter-brevo__button {
      width: 100%;
    }
  }
</style>

{% schema %}
{
  "name": "Newsletter Brevo",
  "settings": [
    {
      "type": "header",
      "content": "Contenido"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Título",
      "default": "Suscríbete al newsletter"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtítulo",
      "default": "Recibe las ofertas más recientes"
    },
    {
      "type": "text",
      "id": "placeholder",
      "label": "Placeholder del campo",
      "default": "tu@email.com"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Texto del botón",
      "default": "Suscribirse"
    },
    {
      "type": "header",
      "content": "Brevo"
    },
    {
      "type": "text",
      "id": "brevo_api_key",
      "label": "API Key",
      "info": "Brevo → Settings → API & Webhooks → v3 Keys",
      "placeholder": "xkeysib_..."
    },
    {
      "type": "number",
      "id": "list_id",
      "label": "List ID",
      "info": "Contacts → Lists"
    },
    {
      "type": "text",
      "id": "category",
      "label": "Categoría",
      "default": "general"
    },
    {
      "type": "header",
      "content": "Privacidad"
    },
    {
      "type": "checkbox",
      "id": "show_privacy",
      "label": "Mostrar texto de privacidad",
      "default": true
    },
    {
      "type": "text",
      "id": "privacy_text",
      "label": "Texto de privacidad",
      "default": "Respetamos tu privacidad. Desuscribete cuando quieras."
    }
  ],
  "presets": [
    {
      "name": "Newsletter Brevo",
      "settings": {
        "title": "Únete a ISSLAM",
        "category": "general"
      }
    }
  ]
}
{% endschema %}
